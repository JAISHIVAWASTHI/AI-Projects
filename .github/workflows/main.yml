name: Calculator App CI/CD

# 1. Define when the workflow runs
on:
  push:
    branches:
      - main
    paths:
      - 'windsurf/calculator-app/**' # Only run when files in this project change
  pull_request:
    branches:
      - main
    paths:
      - 'windsurf/calculator-app/**'
  
  # Allow manual trigger from the GitHub Actions tab
  workflow_dispatch:

# Define environment variables for the project path for cleaner steps
env:
  PROJECT_PATH: windsurf/calculator-app
  FRONTEND_PATH: windsurf/calculator-app/frontend
  BACKEND_PATH: windsurf/calculator-app/backend

jobs:
  build-and-test:
    name: Build & Test Microservice
    runs-on: ubuntu-latest
    
    steps:
      # 2. Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 3. Setup Node.js (use a common version for both)
# Setup Node.js with caching for both backend and frontend lockfiles
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            ${{ env.BACKEND_PATH }}/package-lock.json
            ${{ env.FRONTEND_PATH }}/package-lock.json
      
      # Ensure expected project directories exist (fail early with clear message)
      - name: Verify project paths exist
        run: |
          if [ ! -d "${{ env.BACKEND_PATH }}" ]; then echo "Missing backend path: ${{ env.BACKEND_PATH }}"; exit 1; fi
          if [ ! -d "${{ env.FRONTEND_PATH }}" ]; then echo "Missing frontend path: ${{ env.FRONTEND_PATH }}"; exit 1; fi
      
      # Install Backend Dependencies (use npm ci when a lockfile exists)
      - name: Install Backend Dependencies
        working-directory: ${{ env.BACKEND_PATH }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi
      
      # Install Frontend Dependencies (use npm ci when a lockfile exists)
      - name: Install Frontend Dependencies
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi
      
      # Run tests (do not fail if test script is not defined)
      - name: Run Backend Tests
        working-directory: ${{ env.BACKEND_PATH }}
        run: npm run test --if-present
      
      - name: Run Frontend Tests
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run test --if-present
      
      # Build (do not fail if build script is not defined)
      - name: Build Backend (TypeScript compile)
        working-directory: ${{ env.BACKEND_PATH }}
        run: npm run build --if-present
      
      - name: Build Frontend (React production build)
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run build --if-present
      
      # --- Deployment Steps (Optional, highly dependent on target) ---
      
      # 7. (Optional) Deployment Step (Example: Deploying the build artifacts)
      # This step would typically involve using cloud provider actions (AWS, Azure, GCP)
      # or self-hosted runners to push the built code to a server.
      
      # - name: Deploy to Cloud Service
      #   uses: your-deployment-action/deploy@v1 
      #   if: github.ref == 'refs/heads/main' # Only deploy if pushing to main
      #   with:
      #     ... deployment credentials and specific paths ...
