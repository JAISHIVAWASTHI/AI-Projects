name: Calculator App CI/CD

# 1. Define when the workflow runs
on:
  push:
    branches:
      - main
    paths:
      - 'windsurf/calculator-app/**' # Only run when files in this project change
  pull_request:
    branches:
      - main
    paths:
      - 'windsurf/calculator-app/**'
  
  # Allow manual trigger from the GitHub Actions tab
  workflow_dispatch:

# Define environment variables for the project path for cleaner steps
env:
  PROJECT_PATH: windsurf/calculator-app
  FRONTEND_PATH: windsurf/calculator-app/frontend
  BACKEND_PATH: windsurf/calculator-app/backend

jobs:
  build-and-test:
    name: Build & Test Calculator App
    runs-on: ubuntu-latest
    
    steps:
      # 2. Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 3. Setup Node.js (v20 LTS) with caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            ${{ env.BACKEND_PATH }}/package-lock.json
            ${{ env.FRONTEND_PATH }}/package-lock.json
      
      # 4. Verify Project Paths Exist
      - name: Verify Project Paths Exist
        run: |
          if [ ! -d "${{ env.BACKEND_PATH }}" ]; then 
            echo "::error::Missing backend path: ${{ env.BACKEND_PATH }}. Check monorepo structure."
            exit 1
          fi
          if [ ! -d "${{ env.FRONTEND_PATH }}" ]; then 
            echo "::error::Missing frontend path: ${{ env.FRONTEND_PATH }}. Check monorepo structure."
            exit 1
          fi
      
      # 5. Install Backend Dependencies (WITH FALLBACK)
      - name: Install Backend Dependencies
        working-directory: ${{ env.BACKEND_PATH }}
        run: |
          if [ -f package-lock.json ]; then
            # Attempt npm ci first for speed and consistency.
            # Use || npm install as a fallback if ci fails (e.g., due to lockfile sync issues)
            npm ci --prefer-offline --no-audit --no-fund || {
              echo "::warning::npm ci failed. Falling back to npm install to fix lockfile."
              npm install --no-audit --no-fund
            }
          else
            # If no lockfile exists, proceed with a regular install.
            npm install --no-audit --no-fund
          fi
      
      # 6. Install Frontend Dependencies (WITH FALLBACK)
      - name: Install Frontend Dependencies
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --no-fund || {
              echo "::warning::npm ci failed. Falling back to npm install to fix lockfile."
              npm install --no-audit --no-fund
            }
          else
            npm install --no-audit --no-fund
          fi
      
      # 7. Execute Unit and Integration Tests
      # - name: Run Backend UNIT Tests
      #   working-directory: ${{ env.BACKEND_PATH }}
      #   run: npm run test:unit --if-present
        
      # - name: Run Backend INTEGRATION Tests
      #   working-directory: ${{ env.BACKEND_PATH }}
      #   run: npm run test:integration --if-present
      
      # - name: Run Frontend Tests
      #   working-directory: ${{ env.FRONTEND_PATH }}
      #   run: npm test --if-present 
      
      # # 8. Build Production Assets
      # - name: Build Backend (TypeScript compile)
      #   working-directory: ${{ env.BACKEND_PATH }}
      #   run: npm run build --if-present
      
      # - name: Build Frontend (React production build)
      #   working-directory: ${{ env.FRONTEND_PATH }}
      #   run: npm run build --if-present
      
      # 9. Artifact Upload
      - name: Archive Production Artifacts (Backend & Frontend)
        uses: actions/upload-artifact@v4
        with:
          name: calculator-app-build-artifacts
          path: |
            ${{ env.BACKEND_PATH }}/dist 
            ${{ env.FRONTEND_PATH }}/build
